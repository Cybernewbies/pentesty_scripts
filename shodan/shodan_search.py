import shodan
import time
import sys

SHODAN_API_KEY = ""

api = shodan.Shodan(SHODAN_API_KEY)
ioc_filename = "netblock.txt"


def retrieve_api_results(query):
    results = api.search('net:%s' % query)
    #Show the results
    print 'Results found: %s \n' % results['total']
    #print results
    for result in results['matches']:
        print 'Timestamp:%s' % result['timestamp']
        print 'IP: %s Port: %s' % (result['ip_str'], result['port'])
        print result['data']
        print ''
    #sleep cuz the api sux
    time.sleep(15)

#open ths file of netblocks, ips, or domains
try:
	raw_iocs = open(ioc_filename)
except Exception, e:
	sys.exit('%s : File not found' % ioc_filename)

#loop thru each one, strip at the end for any rogue whitespace
#and skip any comments
for raw_ioc in raw_iocs:
    while True:
        try:
            if not raw_ioc.strip():
                continue
            # skip any comments
            elif raw_ioc.startswith("#"):
                continue
            else:
                print 'netblock:%s' % raw_ioc.strip()
                retrieve_api_results(raw_ioc.strip())
            break
        except shodan.APIError, e:
            print 'Error: %s for %s, retrying...' % (e, raw_ioc.strip())  
