__author__ = 'cg'
'''
based on 
gist: https://gist.github.com/anshumanbh/96a0b81dfe318e9e956013209e178fa9
https://github.com/jgamblin/censys/blob/master/censys.py
'''

import sys
import requests
import os
import json

domain = "spotify.com"
API_URL = "https://www.censys.io/api/v1"
UID = ""
KEY = ""
WEBSITE = domain
subdomain_list = []

query = 'parsed.names:{} (includes subdomains)'.format(WEBSITE)

def get_cert_parsed_names(query):
    pages = float('inf')
    page = 1
    subdomain_list = []
    try:
        while page <= pages:
            params = {'query' : query, 'page' : page}
            res = requests.post(API_URL + "/search/certificates", json = params, auth=(UID, KEY))
            if res.status_code != 200:
                print "error occurred: {}" .format(res.json()["error"])
                sys.exit(1)
            else:
                payload = res.json()
                for r in payload['results']:
                    str = r["parsed.subject_dn"]
                    cn = str.split(",")[0]
                    #print cn
                    subdomain = cn.split("=")
                    print subdomain[1]       
                pages = payload['metadata']['pages']
                page += 1
    except Exception as e:
        print e

get_cert_parsed_names(query)